<?php

namespace Automattic\WooCommerce\Admin\Features\OnboardingTasks\Tasks;

use Automattic\WooCommerce\Admin\Features\Features;
use Automattic\WooCommerce\Admin\Features\OnboardingTasks\Tasks\Products;

/**
 * HeadstartProducts Task
 */
class HeadstartProducts extends Products {
	/**
	 * Task completion.
	 *
	 * @return bool
	 */
	public function is_complete() {
		return self::has_products();
	}

	/**
	 * Check if the store has any published products,
	 * but exclude sample products generated by Headstart themes.
	 *
	 * @return bool
	 */
	public static function has_products() {
		$product_query = array(
			'post_type' => 'product',
			'post_status' => 'publish',
			'fields' => 'ids',
			'meta_query' => array(
				'relation' => 'OR',
				array(
					'key' => '_headstart_post',
					'compare' => 'NOT EXISTS'
				),
				array(
					'key' => '_edit_last',
					'compare' => 'EXISTS'
				)
			)
		);
		$products = get_posts( $product_query );
		$product_count = count( $products );

		return $product_count > 0;
	}

	/**
	 * Title.
	 *
	 * @return string
	 */
	public function get_title() {
		$data = $this->get_onboarding_data();
		$already_selling_venues = array( 'other', 'brick-mortar', 'other-woocommerce', 'brick-mortar-other' );
		$already_selling = in_array( $data['selling_venues'], $already_selling_venues );

		if ( $already_selling ) {
			return __( 'Import your products', 'woocommerce' );
		}

		return __( 'Add your products', 'woocommerce' );
	}

	/**
	 * Gets the profiler onboarding option data.
	 *
	 * @return array
	 */
	private function get_onboarding_data() {
		$onboarding_data = get_option( 'woocommerce_onboarding_profile', array() );
		if ( ! is_array( $onboarding_data ) ) {
			return [];
		}
		return $onboarding_data;
	}
}
